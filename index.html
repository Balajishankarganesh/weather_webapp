<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Live Weather</title>
    <meta name="description" content="Live weather with city search and location support." />
    <style>
      /* Color system (exactly 5):
         - Primary: #2563eb (blue)
         - Accent:  #f59e0b (amber)
         - Neutrals: #ffffff (white), #f3f4f6 (light gray), #111827 (near-black text)
      */

      :root {
        --primary: #2563eb;
        --accent:  #f59e0b;
        --bg:      #ffffff;
        --bg-soft: #f3f4f6;
        --text:    #111827;

        /* Weather themes (solid colors, no gradients) */
        --theme-clear:  #bfe0ff; /* light blue sky */
        --theme-clouds: #dbe2ea; /* cool gray */
        --theme-rain:   #b7c6d6; /* muted blue-gray */
        --theme-snow:   #eef2f7; /* very light cool */
        --theme-fog:    #e8ebef; /* pale fog gray */
        --theme-storm:  #c4c8d1; /* steel gray */

        /* Night variants */
        --theme-night:    #0b1220; /* deep navy */
        --theme-night-dim:#121a2a;
      }

      html, body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue",
          Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        color: var(--text);
        background: var(--theme-clear);
        transition: background-color 240ms ease;
      }

      /* Layout */
      .page {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 16px;
        background: var(--bg);
        border-bottom: 1px solid var(--bg-soft);
      }

      .container {
        width: 100%;
        max-width: 960px;
        margin: 0 auto;
        padding: 0 16px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .brand h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.2px;
      }

      /* Controls */
      .controls {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
      }

      .row {
        display: flex;
        gap: 8px;
      }

      .row.wrap {
        flex-wrap: wrap;
      }

      input[type="text"] {
        flex: 1 1 200px;
        padding: 10px 12px;
        border: 1px solid var(--bg-soft);
        border-radius: 10px;
        background: var(--bg);
        color: var(--text);
        outline: none;
      }

      input[type="text"]::placeholder {
        color: #6b7280; /* slate-500 */
      }

      button {
        appearance: none;
        border: none;
        border-radius: 10px;
        padding: 10px 12px;
        cursor: pointer;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
      }

      button.secondary {
        background: var(--bg-soft);
        color: var(--text);
        border: 1px solid var(--bg-soft);
      }

      button.ghost {
        background: transparent;
        color: var(--primary);
        border: 1px solid var(--primary);
      }

      .unit-toggle {
        display: inline-flex;
        border: 1px solid var(--bg-soft);
        background: var(--bg);
        border-radius: 10px;
        overflow: hidden;
      }

      .unit-toggle button {
        background: transparent;
        color: var(--text);
        border-radius: 0;
        border: none;
        padding: 10px 14px;
      }

      .unit-toggle button.active {
        background: var(--primary);
        color: #fff;
      }

      .suggestions {
        display: none;
        position: absolute;
        z-index: 20;
        margin-top: 4px;
        width: 100%;
        max-width: 560px;
        background: var(--bg);
        border: 1px solid var(--bg-soft);
        border-radius: 10px;
        overflow: hidden;
      }

      .suggestions.visible {
        display: block;
      }

      .suggestions button {
        width: 100%;
        text-align: left;
        background: transparent;
        color: var(--text);
        border: none;
        padding: 10px 12px;
        border-bottom: 1px solid var(--bg-soft);
      }
      .suggestions button:last-child {
        border-bottom: none;
      }
      .suggestions button:hover,
      .suggestions button:focus {
        background: var(--bg-soft);
      }

      /* Main content */
      main {
        flex: 1;
      }

      .hero {
        padding: 24px 0 12px;
      }

      .status {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #374151; /* gray-700 */
        font-size: 14px;
      }

      .cards {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 16px;
      }

      @media (min-width: 640px) {
        .cards {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (min-width: 900px) {
        .cards {
          grid-template-columns: 2fr 1fr;
        }
      }

      .panel {
        background: var(--bg);
        border: 1px solid var(--bg-soft);
        border-radius: 16px;
        padding: 16px;
      }

      /* Current weather card */
      .current {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 12px;
      }

      .place {
        font-weight: 700;
        font-size: 18px;
        margin: 0 0 4px;
      }
      .meta {
        color: #4b5563; /* gray-600 */
        font-size: 14px;
      }

      .temp {
        font-size: 48px;
        font-weight: 800;
        letter-spacing: -1px;
      }
      .temp small {
        font-size: 16px;
        font-weight: 600;
        margin-left: 4px;
        color: #374151;
      }

      .metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 12px;
      }

      .metric {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--bg-soft);
        border-radius: 12px;
        padding: 10px;
      }

      .metric label {
        font-size: 12px;
        color: #374151;
        display: block;
      }

      .metric strong {
        font-size: 14px;
      }

      /* Forecast */
      .forecast {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
      }

      .day {
        background: var(--bg);
        border: 1px solid var(--bg-soft);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
      }

      .day h4 {
        margin: 0 0 8px;
        font-size: 14px;
      }

      .wicon {
        width: 36px;
        height: 36px;
        margin: 0 auto 6px;
      }

      .range {
        font-size: 13px;
      }

      /* Loading & Error */
      .notice {
        display: none;
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        background: var(--bg);
        border: 1px solid var(--bg-soft);
      }
      .notice.visible { display: block; }
      .notice.loading { border-color: var(--primary); }
      .notice.error { border-color: #ef4444; } /* red-500 */

      footer {
        padding: 20px 16px 40px;
        color: #4b5563;
        font-size: 13px;
      }

      /* Background themes (applied on body) */
      .theme-clear  { background: var(--theme-clear); }
      .theme-clouds { background: var(--theme-clouds); }
      .theme-rain   { background: var(--theme-rain); }
      .theme-snow   { background: var(--theme-snow); }
      .theme-fog    { background: var(--theme-fog); }
      .theme-storm  { background: var(--theme-storm); }
      .night        { background: var(--theme-night); color: #e5e7eb; }
      .night .meta,
      .night .status,
      .night .metric label { color: #cbd5e1; }
      .night .panel,
      .night .day,
      .night .metric { background: var(--theme-night-dim); border-color: #1f2937; }
      .night input[type="text"] { background: var(--theme-night-dim); color: #e5e7eb; border-color: #1f2937; }
      .night .suggestions { background: var(--theme-night-dim); border-color: #1f2937; }
      .night .suggestions button { color: #e5e7eb; border-bottom-color: #1f2937; }
      .night .suggestions button:hover { background: #0f1626; }
      .night button.secondary { background: #0f1626; color: #e5e7eb; border-color: #1f2937; }
      .night .unit-toggle { background: #0f1626; border-color: #1f2937; }
    </style>
  </head>
  <body class="theme-clear">
    <div class="page">
      <header>
        <div class="container">
          <div class="brand" aria-label="Live Weather">
            <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="12" cy="12" r="6" fill="var(--accent)" />
            </svg>
            <h1 class="text-balance">Live Weather</h1>
          </div>

          <div class="controls">
            <div class="row wrap" role="search" aria-label="City search">
              <div style="position: relative; flex: 1 1 320px; max-width: 560px;">
                <label class="sr-only" for="city">Search city</label>
                <input id="city" name="city" type="text" placeholder="Search city (e.g., London, Tokyo)"
                  autocomplete="off" aria-autocomplete="list" aria-controls="suggestions-list" />
                <div id="suggestions" class="suggestions" role="listbox" aria-label="City suggestions"></div>
              </div>
              <button id="searchBtn" aria-label="Search by city">Search</button>
              <button id="locBtn" class="secondary" aria-label="Use my location">Use my location</button>
            </div>

            <div class="row" aria-label="Unit toggle">
              <div class="unit-toggle" role="tablist" aria-label="Unit selection">
                <button id="cBtn" class="active" role="tab" aria-selected="true">Â°C</button>
                <button id="fBtn" role="tab" aria-selected="false">Â°F</button>
              </div>
              <div class="status" id="status" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </header>

      <main>
        <section class="hero">
          <div class="container">
            <div id="notice" class="notice" role="status" aria-live="polite"></div>

            <div class="cards">
              <article class="panel" aria-labelledby="current-heading">
                <div class="current">
                  <div>
                    <h2 id="current-heading" class="place">â</h2>
                    <div class="meta" id="meta">â</div>
                    <div class="metric" style="margin-top: 10px;">
                      <div class="wicon" id="currentIcon" aria-hidden="true"></div>
                      <div>
                        <div id="currentDesc">â</div>
                      </div>
                    </div>
                  </div>
                  <div class="temp"><span id="temp">â</span><small id="unit">Â°C</small></div>
                </div>

                <div class="metrics" aria-label="Details">
                  <div class="metric">
                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill="var(--primary)"/>
                    </svg>
                    <div>
                      <label>Wind</label>
                      <strong id="wind">â</strong>
                    </div>
                  </div>
                  <div class="metric">
                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M6 19a6 6 0 0 1 12 0" stroke="var(--primary)" stroke-width="2" fill="none"/>
                      <path d="M12 3v7" stroke="var(--primary)" stroke-width="2" />
                    </svg>
                    <div>
                      <label>Precip</label>
                      <strong id="precip">â</strong>
                    </div>
                  </div>
                  <div class="metric">
                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                      <circle cx="12" cy="12" r="9" stroke="var(--primary)" stroke-width="2" fill="none"/>
                      <path d="M12 7v6l4 2" stroke="var(--primary)" stroke-width="2" fill="none"/>
                    </svg>
                    <div>
                      <label>Feels like</label>
                      <strong id="feels">â</strong>
                    </div>
                  </div>
                  <div class="metric">
                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M17 18a5 5 0 1 1-10 0c0-3 5-10 5-10s5 7 5 10z" fill="var(--primary)"/>
                    </svg>
                    <div>
                      <label>Direction</label>
                      <strong id="windDir">â</strong>
                    </div>
                  </div>
                </div>
              </article>

              <aside class="panel" aria-labelledby="forecast-heading">
                <h3 id="forecast-heading" style="margin:0 0 10px; font-size:16px;">5âDay Forecast</h3>
                <div class="forecast" id="forecast" role="list" aria-label="Daily forecast"></div>
              </aside>
            </div>
          </div>
        </section>
      </main>

      <footer>
        <div class="container">
            Build By Balaji 
        </div>
      </footer>
    </div>

    <script>
      //  Full client-side logic for search, geolocation, unit toggle, theming, and forecast

      // Minimal state
      const state = {
        unit: localStorage.getItem("unit") || "C", // "C" | "F"
        place: JSON.parse(localStorage.getItem("place") || "null"), // { name, country, lat, lon, timezone }
      };

      // Elements
      const noticeEl = document.getElementById("notice");
      const statusEl = document.getElementById("status");
      const cityInput = document.getElementById("city");
      const suggestionsEl = document.getElementById("suggestions");

      const unitEl = document.getElementById("unit");
      const tempEl = document.getElementById("temp");
      const metaEl = document.getElementById("meta");
      const placeEl = document.getElementById("current-heading");
      const currentDescEl = document.getElementById("currentDesc");
      const currentIconEl = document.getElementById("currentIcon");

      const windEl = document.getElementById("wind");
      const windDirEl = document.getElementById("windDir");
      const precipEl = document.getElementById("precip");
      const feelsEl = document.getElementById("feels");

      const forecastEl = document.getElementById("forecast");

      const cBtn = document.getElementById("cBtn");
      const fBtn = document.getElementById("fBtn");
      const searchBtn = document.getElementById("searchBtn");
      const locBtn = document.getElementById("locBtn");

      // Utils
      const degToCompass = (num) => {
        const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
        return dirs[Math.round(num / 22.5) % 16];
      };

      const cToF = (c) => (c * 9) / 5 + 32;
      const mmToIn = (mm) => mm / 25.4;

      const setUnitUI = () => {
        unitEl.textContent = state.unit === "C" ? "Â°C" : "Â°F";
        cBtn.classList.toggle("active", state.unit === "C");
        fBtn.classList.toggle("active", state.unit === "F");
      };

      function showNotice(text, type = "loading") {
        noticeEl.textContent = text;
        noticeEl.className = "notice visible " + type;
      }
      function hideNotice() {
        noticeEl.className = "notice";
        noticeEl.textContent = "";
      }

      function setStatus(text) {
        statusEl.textContent = text || "";
      }

      // Weather code mappings
      function codeToInfo(code) {
        // Based on WMO codes
        // clear(0), mainly clear(1), partly cloudy(2), overcast(3)
        // fog(45,48), drizzle(51,53,55), freezing drizzle(56,57)
        // rain(61,63,65), freezing rain(66,67)
        // snow(71,73,75), snow grains(77), rain showers(80,81,82)
        // snow showers(85,86), thunderstorm(95,96,99)
        if ([0,1].includes(code)) return { group: "clear", desc: "Clear" };
        if ([2,3].includes(code)) return { group: "clouds", desc: "Cloudy" };
        if ([45,48].includes(code)) return { group: "fog", desc: "Fog" };
        if ([51,53,55,56,57].includes(code)) return { group: "rain", desc: "Drizzle" };
        if ([61,63,65,66,67,80,81,82].includes(code)) return { group: "rain", desc: "Rain" };
        if ([71,73,75,77,85,86].includes(code)) return { group: "snow", desc: "Snow" };
        if ([95,96,99].includes(code)) return { group: "storm", desc: "Thunderstorm" };
        return { group: "clouds", desc: "Cloudy" };
      }

      function renderIcon(group, isDay) {
        // Simple inline SVG per group
        const color = "currentColor";
        const sun = '<circle cx="12" cy="12" r="4" fill="var(--accent)"/>';
        const rays = '<g stroke="var(--accent)" stroke-width="2"><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/><line x1="4.2" y1="4.2" x2="6.6" y2="6.6"/><line x1="17.4" y1="17.4" x2="19.8" y2="19.8"/><line x1="17.4" y1="6.6" x2="19.8" y2="4.2"/><line x1="4.2" y1="19.8" x2="6.6" y2="17.4"/></g>';
        const cloud = '<g fill="#9ca3af"><ellipse cx="9" cy="14" rx="5" ry="3.2"/><ellipse cx="14.5" cy="13.4" rx="4" ry="3"/></g>';
        const raindrops = '<g fill="#60a5fa"><path d="M8 15c1 1.6-1 3-2 1.2 0 0 1-2.1 2-1.2z"/><path d="M12 16c1 1.6-1 3-2 1.2 0 0 1-2.1 2-1.2z"/><path d="M16 15c1 1.6-1 3-2 1.2 0 0 1-2.1 2-1.2z"/></g>';
        const snow = '<g fill="#e5e7eb"><circle cx="8" cy="16" r="1"/><circle cx="12" cy="17" r="1"/><circle cx="16" cy="16" r="1"/></g>';
        const lightning = '<path d="M12 8l-2 4h3l-1 4 4-6h-3l1-2z" fill="#f59e0b"/>';
        const fog = '<g stroke="#9ca3af" stroke-width="2"><line x1="5" y1="16" x2="19" y2="16"/><line x1="3" y1="19" x2="17" y2="19"/></g>';
        const moon = '<path d="M15 4.5A7.5 7.5 0 1 0 19.5 15 6 6 0 0 1 15 4.5z" fill="#e5e7eb"/>';

        let body = "";
        switch (group) {
          case "clear":
            body = isDay ? `${sun}${rays}` : `${moon}`;
            break;
          case "clouds":
            body = isDay ? `${sun}${cloud}` : `${moon}${cloud}`;
            break;
          case "rain":
            body = `${cloud}${raindrops}`;
            break;
          case "snow":
            body = `${cloud}${snow}`;
            break;
          case "fog":
            body = `${cloud}${fog}`;
            break;
          case "storm":
            body = `${cloud}${lightning}`;
            break;
          default:
            body = `${cloud}`;
        }
        return `<svg viewBox="0 0 24 24" width="36" height="36" aria-hidden="true">${body}</svg>`;
      }

      function applyTheme(group, isDay) {
        const b = document.body;
        b.classList.remove("theme-clear","theme-clouds","theme-rain","theme-snow","theme-fog","theme-storm","night");

        const themeClass = {
          clear: "theme-clear",
          clouds: "theme-clouds",
          rain: "theme-rain",
          snow: "theme-snow",
          fog: "theme-fog",
          storm: "theme-storm",
        }[group] || "theme-clouds";

        b.classList.add(themeClass);
        if (!isDay) b.classList.add("night");
      }

      // Data fetching
      async function geocode(name) {
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=5&language=en&format=json`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Geocoding failed");
        return res.json();
      }

      async function weather(lat, lon, timezone) {
        // Request current and daily forecast
        // OpenâMeteo supports current and daily via 'current=' and 'daily=' params
        const params = new URLSearchParams({
          latitude: String(lat),
          longitude: String(lon),
          current: [
            "temperature_2m",
            "apparent_temperature",
            "is_day",
            "precipitation",
            "weather_code",
            "wind_speed_10m",
            "wind_direction_10m",
          ].join(","),
          daily: [
            "weather_code",
            "temperature_2m_max",
            "temperature_2m_min",
          ].join(","),
          timezone: timezone || "auto",
        });
        const url = `https://api.open-meteo.com/v1/forecast?${params.toString()}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Weather fetch failed");
        return res.json();
      }

      // Render current
      function renderCurrent(place, data) {
        const c = data.current;
        const info = codeToInfo(c.weather_code);
        const isDay = !!c.is_day;

        placeEl.textContent = `${place.name}, ${place.country || ""}`.replace(/, $/,"");
        metaEl.textContent = new Date().toLocaleString(undefined, { hour: "2-digit", minute: "2-digit" });

        const tVal = state.unit === "C" ? c.temperature_2m : cToF(c.temperature_2m);
        const feelsVal = state.unit === "C" ? c.apparent_temperature : cToF(c.apparent_temperature);

        tempEl.textContent = Math.round(tVal);
        currentDescEl.textContent = info.desc + (isDay ? "" : " (night)");
        currentIconEl.innerHTML = renderIcon(info.group, isDay);

        windEl.textContent = `${Math.round(c.wind_speed_10m)} km/h`;
        windDirEl.textContent = `${degToCompass(c.wind_direction_10m)}`;
        precipEl.textContent = state.unit === "C"
          ? `${(c.precipitation ?? 0).toFixed(1)} mm`
          : `${mmToIn(c.precipitation ?? 0).toFixed(2)} in`;
        feelsEl.textContent = `${Math.round(feelsVal)}Â°`;

        applyTheme(info.group, isDay);
      }

      // Render forecast (5 days)
      function renderForecast(data) {
        const d = data.daily;
        forecastEl.innerHTML = "";
        if (!d || !d.time) return;

        for (let i = 0; i < Math.min(d.time.length, 5); i++) {
          const date = new Date(d.time[i] + "T12:00:00");
          const name = date.toLocaleDateString(undefined, { weekday: "short" });

          const code = d.weather_code[i];
          const info = codeToInfo(code);
          const tmin = d.temperature_2m_min[i];
          const tmax = d.temperature_2m_max[i];
          const minVal = state.unit === "C" ? tmin : cToF(tmin);
          const maxVal = state.unit === "C" ? tmax : cToF(tmax);

          const card = document.createElement("div");
          card.className = "day";
          card.setAttribute("role", "listitem");
          card.innerHTML = `
            <h4>${name}</h4>
            <div class="wicon">${renderIcon(info.group, true)}</div>
            <div style="font-size: 13px; color:#374151;">${info.desc}</div>
            <div class="range"><strong>${Math.round(maxVal)}Â°</strong> / ${Math.round(minVal)}Â°</div>
          `;
          forecastEl.appendChild(card);
        }
      }

      async function updateForPlace(place) {
        try {
          showNotice("Loading weatherâ¦", "loading");
          setStatus(`Fetching ${place.name}â¦`);
          const data = await weather(place.lat, place.lon, place.timezone);

          renderCurrent(place, data);
          renderForecast(data);

          hideNotice();
          setStatus(`Updated ${new Date().toLocaleTimeString()}`);
        } catch (err) {
          showNotice("Could not load weather. Please try again.", "error");
          setStatus("");
          console.error(err);
        }
      }

      function savePlace(place) {
        state.place = place;
        localStorage.setItem("place", JSON.stringify(place));
      }

      // Search flow
      async function handleSearch(name) {
        if (!name || !name.trim()) return;
        try {
          setStatus("Searchingâ¦");
          const results = await geocode(name.trim());
          const list = results?.results || [];

          // If exactly one, select; else show suggestions
          if (list.length === 1) {
            const p = normalizePlace(list[0]);
            savePlace(p);
            cityInput.value = `${p.name}${p.country ? ", " + p.country : ""}`;
            suggestionsEl.classList.remove("visible");
            await updateForPlace(p);
          } else if (list.length > 1) {
            renderSuggestions(list.slice(0, 5));
          } else {
            suggestionsEl.classList.remove("visible");
            showNotice("No matches found. Try another city.", "error");
            setStatus("");
          }
        } catch (e) {
          showNotice("Search failed. Check your connection.", "error");
          setStatus("");
        }
      }

      function renderSuggestions(items) {
        suggestionsEl.innerHTML = "";
        suggestionsEl.classList.add("visible");
        suggestionsEl.setAttribute("id", "suggestions-list");

        items.forEach((it, idx) => {
          const p = normalizePlace(it);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.role = "option";
          btn.ariaSelected = idx === 0 ? "true" : "false";
          btn.textContent = `${p.name}${p.admin1 ? ", " + p.admin1 : ""}${p.country ? ", " + p.country : ""}`;
          btn.addEventListener("click", async () => {
            savePlace(p);
            cityInput.value = `${p.name}${p.country ? ", " + p.country : ""}`;
            suggestionsEl.classList.remove("visible");
            await updateForPlace(p);
          });
          suggestionsEl.appendChild(btn);
        });
      }

      function normalizePlace(item) {
        return {
          name: item.name,
          country: item.country,
          admin1: item.admin1,
          lat: item.latitude,
          lon: item.longitude,
          timezone: item.timezone || "auto",
        };
      }

      // Geolocation
      function useMyLocation() {
        if (!navigator.geolocation) {
          showNotice("Geolocation not supported in this browser.", "error");
          return;
        }
        showNotice("Getting your locationâ¦", "loading");
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const p = { name: "My location", country: "", lat, lon, timezone: "auto" };
          savePlace(p);
          cityInput.value = "My location";
          await updateForPlace(p);
        }, () => {
          showNotice("Could not get location permission.", "error");
        }, { enableHighAccuracy: true, timeout: 10000 });
      }

      // Unit toggle
      function setUnit(unit) {
        if (unit !== "C" && unit !== "F") return;
        state.unit = unit;
        localStorage.setItem("unit", state.unit);
        setUnitUI();
        // Re-render with existing data by refetching (keeps logic simple)
        if (state.place) updateForPlace(state.place);
      }

      // Events
      searchBtn.addEventListener("click", () => handleSearch(cityInput.value));
      cityInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSearch(cityInput.value);
      });
      cityInput.addEventListener("input", () => {
        if (!cityInput.value.trim()) suggestionsEl.classList.remove("visible");
      });

      locBtn.addEventListener("click", useMyLocation);

      cBtn.addEventListener("click", () => setUnit("C"));
      fBtn.addEventListener("click", () => setUnit("F"));

      // Init
      (async function init() {
        setUnitUI();
        if (state.place) {
          cityInput.value = `${state.place.name}${state.place.country ? ", " + state.place.country : ""}`;
          await updateForPlace(state.place);
        } else {
          // Try quick geolocation for first-time users
          // Silently skip if blocked
          navigator.geolocation?.getCurrentPosition(async (pos) => {
            const p = { name: "My location", country: "", lat: pos.coords.latitude, lon: pos.coords.longitude, timezone: "auto" };
            savePlace(p);
            cityInput.value = "My location";
            await updateForPlace(p);
          }, () => {});
        }
      })();
    </script>
  </body>
</html>